---
title: 问题
date: 2022-10-30T19:56:01Z
lastmod: 2022-12-31T21:49:52Z
---

# 问题

## 一条SQL语句执行得很慢的原因有哪些

　　**当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为“干净页”**。

### 大多数情况是正常的，只是偶尔会出现很慢的情况。

#### 数据库在刷新脏页

- InnoDB 的 redo log 写满了。这时候系统会停止所有更新操作，把 checkpoint 往前推进，redo log 留出空间可以继续写。

　　![下载.jpg](assets/net-img-1625277244322-1304b001-049b-467f-9207-4012228cca38-20221031123243-oqmq9cu.jpeg)

- 系统内存不足。当需要新的内存页，而内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的是“脏页”，就要先将脏页写到磁盘。为何不直接淘汰内存次需要请求的时候，从磁盘读入数据页，然后拿 redo log 出来应用，是从性能考虑的。如果刷脏页一定会写盘，就保证了每个数据页有两种状态：
  - 一种是内存里存在，内存里就肯定是正确的结果，直接返回；
  - 另一种是内存里没有数据，就可以肯定数据文件上是正确的结果，读入内存后返回。这样的效率最高。

　　**刷脏页虽然是常态，但是出现以下这两种情况，都是会明显影响性能的：**

- 一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长；
- 日志写满，更新全部堵住，写性能跌为 0，这种情况对敏感业务来说，是不能接受的

#### 未拿到锁

### 在数据量不变的情况下，这条SQL语句一直以来都执行的很慢。

- 没用到索引，函数操作导致没有用上索引
- 数据库自己选错索引了

## 如果被驱动表是一个大表，并且是一个冷数据表，除了查询过程中可能会导致 IO 压力大以外，你觉得对这个 MySQL 服务还有什么更严重的影响吗？

## 如果客户端由于压力过大，迟迟不能接收数据，会对服务端造成什么严重的影响。

- 这个问题的核心是，造成了“长事务”。
- 至于长事务的影响，就要结合我们前面文章中提到的锁、MVCC 的知识点了。
  - 如果前面的语句有更新，意味着它们在占用着行锁，会导致别的语句更新被锁住；
  - 当然读的事务也有问题，就是会导致 undo log 不能被回收，导致回滚段空间膨胀。

　　‍
